<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-139640266-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Agora-cl" href="/opensearch.xml">
<script src="https://buttons.github.io/buttons.js"></script><title data-react-helmet="true">About Bazel | Agora-cl</title><meta data-react-helmet="true" property="og:url" content="https://agora-cl-docs.bosagora.io/docs/reading/bazel"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="About Bazel | Agora-cl"><meta data-react-helmet="true" name="description" content="This page explains why Agora-cl uses a special build system called Bazel to compile everything in our monorepository."><meta data-react-helmet="true" property="og:description" content="This page explains why Agora-cl uses a special build system called Bazel to compile everything in our monorepository."><link data-react-helmet="true" rel="shortcut icon" href="/img/bosagora-logo.png"><link data-react-helmet="true" rel="canonical" href="https://agora-cl-docs.bosagora.io/docs/reading/bazel"><link data-react-helmet="true" rel="alternate" href="https://agora-cl-docs.bosagora.io/docs/reading/bazel" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://agora-cl-docs.bosagora.io/docs/reading/bazel" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.d023a482.css">
<link rel="preload" href="/assets/js/runtime~main.fbada0f2.js" as="script">
<link rel="preload" href="/assets/js/main.f24723cf.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/getting-started"><img src="/img/bosagora-logo.png" alt="logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/bosagora-logo.png" alt="logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Agora-cl Documentation</b></a><a href="https://github.com/zeroone-boa/agora-cl/releases/tag/v3.1.1" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">agora_v3.1.1</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/install/install-with-script">Quick Install</a><a href="https://github.com/zeroone-boa/agora-cl" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://t.me/bosagora_eng" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_fBfG"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started">Table of contents</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/install/install-with-script">Quickstart: Run a node</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/prepare-for-merge">Prepare for The Merge</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/security-best-practices">Security best practices</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/agora-cl-usage/parameters">Command-line options</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/monitoring/checking-status">Check node and validator status</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/troubleshooting/issues-errors">Troubleshooting</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Advanced installation guides</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">How-tos</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Developer wiki</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contribute/contribution-guidelines">Contribute to Agora-cl&#x27;s codebase</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contribute/golang-principles">Golang principles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reading/golang">Golang resources</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/reading/bazel">About Bazel</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">APIs</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Developer concepts</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Misc</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq">Frequently asked questions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/terminology">Glossary</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_dC7a">About Bazel</h1></header><p>This page explains why Agora-cl uses a special build system called <a href="https://bazel.build" target="_blank" rel="noopener noreferrer">Bazel</a> to compile everything in our monorepository.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="why-bazel"></a>Why Bazel?<a class="hash-link" href="#why-bazel" title="Direct link to heading">#</a></h2><p>Instead of using the <code>Go</code> tool to build Agora-cl, our team relies on the <a href="https://bazel.build" target="_blank" rel="noopener noreferrer">Bazel</a> build system used by major companies such as Google, Uber, Coinbase, and more to manage monorepositories. Bazel provides reproducible builds and a sandboxed environment that ensures everyone building Agora-cl has the same experience and can build our entire project from a single command. The rationale for why we chose this system comes down to three major problems we need solved as part of our software development process:</p><ul><li>Bugs introduced as a result of the developer&#x27;s environment being different than that being shipped to users</li><li>Messy dependency management when dealing with a monorepo with multiple programming languages</li><li>Messy deployment and production release configurations via esoteric make files</li></ul><p>Because Agora-cl is a <em>monorepo</em>, it can have many different subprojects with multiple programming languages contained within. For example, while we primarily develop in Go, we could add an Angular application, or Python tools, or more. It is important that dependency management, compilation, and builds are <strong>reproducible and simple</strong> for all developers in the team. Because Ethereum is consensus <em>critical</em> software, we must ensure all developers writing code and checking in new features into our project are using the exact same development environment, so if someone runs into a bug or a failing test, everyone else developing the project will see the bug, and the bug will also be present in the end-result binary. Bazel ensures <strong>hermeticity</strong>, which means that builds are essentially extremely sandboxed, pinned with proper dependencies, Go versions, and will be guaranteed to behave the same despite your machine. This is the <strong>major</strong> reason why we use Bazel instead of the native Go tool.</p><p>Additionally, Bazel provides the following amazing features out of the box:</p><ul><li>Advanced local and remote caching, making it trivial to run CI and tests in a massive codebase</li><li>Some of the most advanced dependency analysis, graph queries, and more, for the entire repository</li><li>An extensible programming language to improve builds and write custom tooling that improves the experience for all</li></ul><p>To better understand some of the deeper rationale of how Bazel has helped large organizations, read Coinbase&#x27;s retrospective on how Bazel helped their development significantly <a href="https://blog.coinbase.com/bootstrapping-the-coinbase-monorepo-575cf981c859" target="_blank" rel="noopener noreferrer">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="cons-of-bazel"></a>Cons of Bazel<a class="hash-link" href="#cons-of-bazel" title="Direct link to heading">#</a></h3><p>Among a few cons of Bazel are:</p><ul><li>Learning curve to understand how its underlying language, Starlark, is used in BUILD files</li><li>Large, initial download of Bazel</li><li>Not enough, comprehensive IDE support for Bazel (although Jetbrains IDEs have good support)</li></ul><p>Thankfully, Agora-cl also builds with <code>go</code> and <code>go</code> modules as well, so your code editor can use its regular Go support when developing for Agora-cl.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="build-files"></a>BUILD Files<a class="hash-link" href="#build-files" title="Direct link to heading">#</a></h2><p>Building with Bazel requires every directory and every package to have a BUILD.bazel file which tells it how it should build the code in question.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="do-i-have-to-edit-build-files-myself"></a>Do I have to edit BUILD files myself?<a class="hash-link" href="#do-i-have-to-edit-build-files-myself" title="Direct link to heading">#</a></h3><p>Most of the time, developers will not need to edit BUILD files themselves. Instead, they can use the following tool:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><pre tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">bazel run //:gazelle -- fix</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>which will edit all BUILD files that need to be changed based on any dependencies that were imported or any files that were added.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="dependency-management"></a>Dependency Management<a class="hash-link" href="#dependency-management" title="Direct link to heading">#</a></h2><p>A large problem in monorepos is, of course, dealing with dependency management. Versioning and building tooling to ensure code is up to date is complicated, especially when you have a monorepo with many subprojects. Bazel handles <em>all</em> dependency management in the monorepo, ensuring there is only a single version of a dependency in the entire project. Bazel provides an incredibly sophisticated dependency query tool called <a href="https://docs.bazel.build/versions/master/query-how-to.html" target="_blank" rel="noopener noreferrer">bazel query</a> which allows you to perform action such as the following:</p><ul><li>Trace the entire dependency chain between two packages</li><li>Look at the dependencies used in test files only</li><li>Why does X dependency require Y dependency?</li><li>What dependency paths do I need to break to make X no longer depend on Y?</li></ul><p>Bazel&#x27;s query tool allows you to create graph visualizations of your entire dependency tree, making it a lot more robust and standardized compared to other methods of managing dependencies in a project.</p><p>All dependencies in the Agora-cl monorepo live in a file called <code>deps.bzl</code> at the top-level of the repository <a href="https://github.com/zeroone-boa/agora-cl/blob/develop/deps.bzl" target="_blank" rel="noopener noreferrer">here</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-add-new-dependencies"></a>How to add new dependencies<a class="hash-link" href="#how-to-add-new-dependencies" title="Direct link to heading">#</a></h3><p>Adding new dependencies to Agora-cl requires specific changes. We have prepared a comprehensive <a href="https://github.com/zeroone-boa/agora-cl/blob/master/DEPENDENCIES.md" target="_blank" rel="noopener noreferrer">DEPENDENCIES.md</a> explaining the required process.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="bazel-and-docker"></a>Bazel and Docker<a class="hash-link" href="#bazel-and-docker" title="Direct link to heading">#</a></h2><p>A common question we get is: &quot;where are Agora-cl&#x27;s Dockerfiles?&quot;. With Bazel, we get a ton of benefits in terms of optimizing our deployment and release process. In particular, we use <a href="https://github.com/bazelbuild/rules_docker" target="_blank" rel="noopener noreferrer"><code>bazel rules docker</code></a> which provides us the ability to specify a base, barebones image, and essentially builds our binary and creates a Docker container as a simple wrapper over our binaries.</p><p>We do not write our own Dockerfiles, as Bazel provides us a more sandboxed, simple experience with all of its benefits. To see an example use of <code>bazel rules docker</code> for how we build a particular package, see <a href="https://github.com/zeroone-boa/agora-cl/blob/aa389c82a157008741450ba1e04d898924734432/tools/bootnode/BUILD.bazel#L36" target="_blank" rel="noopener noreferrer">here</a>.</p><p>To read comprehensive instructions on how to build Agora-cl&#x27;s docker images for your own use, see <a href="/docs/install/install-with-bazel">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="building-production-releases"></a>Building Production Releases<a class="hash-link" href="#building-production-releases" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="with-bazel"></a>With Bazel<a class="hash-link" href="#with-bazel" title="Direct link to heading">#</a></h3><p>Everything in Agora-cl can be built with Bazel using <code>bazel build //...</code>. For example, the Agora node can be built with <code>bazel build //beacon-chain --config=release</code>. The <code>--config=release</code> will apply all compile-time optimizations to the code, and build everything including C dependencies and our cryptography from source. Every package in the Agora-cl monorepo can be build with <code>bazel build</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="with-go"></a>With Go<a class="hash-link" href="#with-go" title="Direct link to heading">#</a></h3><p>Building Agora-cl with Go is possible, but it will use precompiled cryptography to build the final executable. Additionally, it will not perform the compile-time optimizations Bazel does, and can have unexpected issues as you are relinquishing reproducible, hermetic builds which Bazel provides. We always recommend Bazel as the only way to run Agora-cl if you are planning on running it.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/zeroone-boa/agora-cl-docs/edit/master/website/docs/reading/bazel.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_wj+Z"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/reading/golang"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Golang resources</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/how-agora-cl-works/ethereum-public-api"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Eth Beacon Node API Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-bazel" class="table-of-contents__link">Why Bazel?</a><ul><li><a href="#cons-of-bazel" class="table-of-contents__link">Cons of Bazel</a></li></ul></li><li><a href="#build-files" class="table-of-contents__link">BUILD Files</a><ul><li><a href="#do-i-have-to-edit-build-files-myself" class="table-of-contents__link">Do I have to edit BUILD files myself?</a></li></ul></li><li><a href="#dependency-management" class="table-of-contents__link">Dependency Management</a><ul><li><a href="#how-to-add-new-dependencies" class="table-of-contents__link">How to add new dependencies</a></li></ul></li><li><a href="#bazel-and-docker" class="table-of-contents__link">Bazel and Docker</a></li><li><a href="#building-production-releases" class="table-of-contents__link">Building Production Releases</a><ul><li><a href="#with-bazel" class="table-of-contents__link">With Bazel</a></li><li><a href="#with-go" class="table-of-contents__link">With Go</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_SRtH" href="/docs/getting-started"><img src="/img/Agora-cl.svg" alt="Agora-cl Docs" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/Agora-cl.svg" alt="Agora-cl Docs" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Bosagora, Validator Deposit Contract 0xXXX</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fbada0f2.js"></script>
<script src="/assets/js/main.f24723cf.js"></script>
</body>
</html>