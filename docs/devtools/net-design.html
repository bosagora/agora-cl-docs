<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-139640266-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Agora-cl" href="/opensearch.xml">
<script src="https://buttons.github.io/buttons.js"></script><title data-react-helmet="true">Network Design | Agora-cl</title><meta data-react-helmet="true" property="og:url" content="https://agora-cl-docs.bosagora.io/docs/devtools/net-design"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Network Design | Agora-cl"><meta data-react-helmet="true" name="description" content="Objective"><meta data-react-helmet="true" property="og:description" content="Objective"><link data-react-helmet="true" rel="shortcut icon" href="/img/bosagora-logo.png"><link data-react-helmet="true" rel="canonical" href="https://agora-cl-docs.bosagora.io/docs/devtools/net-design"><link data-react-helmet="true" rel="alternate" href="https://agora-cl-docs.bosagora.io/docs/devtools/net-design" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://agora-cl-docs.bosagora.io/docs/devtools/net-design" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9b7cbe7b.css">
<link rel="preload" href="/assets/js/runtime~main.bf2263fc.js" as="script">
<link rel="preload" href="/assets/js/main.a87cd8b8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/getting-started"><img src="/img/bosagora-logo.png" alt="logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/bosagora-logo.png" alt="logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Agora-cl Documentation</b></a><a href="https://github.com/zeroone-boa/agora-cl/releases/tag/v3.1.1" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">agora_v3.1.1</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/install/install-with-script">Quick Install</a><a href="https://github.com/zeroone-boa/agora-cl" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://t.me/bosagora_eng" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1ZXk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started">Table of contents</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/install/install-with-script">Quickstart: Run a node</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/prepare-for-merge">Prepare for The Merge</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/security-best-practices">Security best practices</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/agora-cl-usage/parameters">Command-line options</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/monitoring/checking-status">Check node and validator status</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/troubleshooting/issues-errors">Troubleshooting</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Advanced installation guides</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">How-tos</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Developer wiki</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contribute/contribution-guidelines">Contribute to Agora-cl&#x27;s codebase</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contribute/golang-principles">Golang principles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reading/golang">Golang resources</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reading/bazel">About Bazel</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">APIs</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Developer concepts</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/devtools/init-state">Initial synchronization</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/devtools/net-design">Network design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/devtools/extending-apis">Extending APIs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/architecture-overview">Architecture overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/agora-cl node">Beacon node</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/agora-cl-validator-client">Validator client</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/validator-lifecycle">Validator lifecycle</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/optimistic-sync">Optimistic sync</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/validator-deposit-contract">Validator deposit contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/database-backend-boltdb">BoltDB database</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/p2p-networking">P2P networking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/bls-cryptography">BLS cryptography</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/devtools/end-to-end">End-to-end tests</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Misc</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq">Frequently asked questions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/terminology">Glossary</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Network Design</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="objective"></a>Objective<a class="hash-link" href="#objective" title="Direct link to heading">#</a></h2><p>We aim to achieve a design that will specify the networking requirements needed for interoperability and Mainnet in the Agora-cl Client.</p><p><strong>Background</strong>
Networking is a critical component in building out a client and for communicating and interfacing with other BOA 2.0 clients. The requirements for both interoperability and mainnet are specified in this <a href="https://github.com/ethereum/eth2.0-specs/blob/dev/specs/phase0/p2p-interface.md" target="_blank" rel="noopener noreferrer">doc</a> in the specs repository. This document will primarily deal with the three core aspects required for communicating with other clients.</p><ul><li>1) How peers are discovered</li><li>2) How messages are propagated through the network(gossip).</li><li>3) How peers respond to requests from other peers and vice-versa.</li></ul><p><strong>Overview</strong></p><p>A high level overview of the proposed design. This states the components of the network stack that we need to implement.</p><ul><li>Transport</li><li>Encryption/Identification</li><li>Protocol Negotiation</li><li>Multiplexing</li><li>GossipSub Specification</li><li>Req/Resp Specification</li><li>DiscoveryV5</li></ul><p><strong>Transport</strong></p><p>For network transport we must be able to support TCP connections (UDP not a requirement). We have to be able to manage inbound and outbound tcp connections. Although not a requirement for mainnet, for interoperability all clients will have to be able to support an IPv4 endpoint. Any listening endpoints must be publically communicable, so Circuit Relays, AutoNat, etc are not applicable.</p><p><strong>Current Status in Agora-cl</strong></p><p>Currently we use IPv4 addresses as a default for inbound connections. For interoperability, we can have IPv6 addresses as a default while exposing one IPv4 endpoint as libp2p TCP transport supports listening on multiple addresses simultaneously.</p><p><strong>Encryption &amp; Identification</strong></p><p>For interoperability we will be using SECIO for securing sessions over transports. These are the parameters required:</p><ul><li>Key agreement: ECDH-P256</li><li>Cipher: AES-128.</li><li>Digest: SHA-256.</li><li>Identity: Secp256k1</li></ul><p>In SECIO, channel negotiation begins with a proposal phase,  where we exchange information from each peer which declares the ephemeral key generation curve, the cipher for encryption , and the hash algorithm. If the proposal has any of the fields set incorrectly from the specified interoperability requirements stated above, we reject the peer and disconnect with them. Additioanlly the local peer’s public key, which is used to generate its Peer ID, is also given in the proposal message. This public key is generated using the secp256k1 curve. After performing the key exchange, generating the shared secret and  creating the signer and HMAC signer we can initiate a secure channel with the other peer.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="current-status-in-agora-cl"></a>Current Status in Agora-cl<a class="hash-link" href="#current-status-in-agora-cl" title="Direct link to heading">#</a></h2><p>Currently in Agora-cl we do use SECIO for securing sessions, and a Peer’s identity is generated using the Secp256k1 curve. However we haven’t enforced that the ephemeral key generation curve, cipher for encryption and hash algorithm are the ones that are required for interoperability We would need to strictly define these when peers are making their initial proposal. If they do not adhere to them, we reject and disconnect from those peers.</p><p><strong>Protocol Negotiation</strong>
We must use the multistream-select specification with id <a href="https://github.com/multiformats/multistream-select/" target="_blank" rel="noopener noreferrer">/multistream/1.0.0</a></p><p>This is the default multistream multiplexer framework in go-libp2p.</p><p><strong>Multiplexing</strong></p><p>We need to support the <code>/mplex/6.7.0</code> multiplexer, which is dynamically decided upon by libp2p at runtime. This is, along with the <code>/yamux/1.0.0</code> multiplexer are the defaults for the libp2p constructor. See defaults <a href="https://github.com/libp2p/go-libp2p/blob/d87f89314c795f87f32b0c900243728f1481ddb7/defaults.go#L30" target="_blank" rel="noopener noreferrer">here</a>. No changes are needed to support both of these multiplexers.</p><p><strong>GossipSub Specification</strong>
We currently support the most basic gossip sub approach, but we need to utilize the right parameters as specified in the configuration in the networking specification.</p><p><strong>Topic Mapping</strong></p><p>The specification outlines specific topics we need to support and their topic names as a standard we must enforce. Both unaggregated and aggregated attestations <strong>will go towards the same topic</strong>, but we should have the ability in Agora-cl to process aggregated ones from the network.
We need to enforce the max gossip sub message size properly when sanitizing received and sent data.</p><p><strong>Req/Resp Specification</strong></p><p>Data sent over the wire is enforced as encoded using SSZ for interoperability. We have decided we can support protobuf encoded data if we are communicating between agora-cl clients, specifically due to efficiency and tooling improvements.</p><p><strong>DiscoveryV5</strong>
Discv5 is not a hard requirement for our testnets, as we can continue supporting kademlia for now. However it is still required for interoperability, since Discv5 only works for UDP transports, so alternative discovery methods need to be implemented.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="detailed-design"></a>Detailed Design<a class="hash-link" href="#detailed-design" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="handshake--protocol-negotiation"></a>Handshake / Protocol Negotiation<a class="hash-link" href="#handshake--protocol-negotiation" title="Direct link to heading">#</a></h3><p>The <a href="https://github.com/zeroone-boa/agora-cl/blob/715b9cd5bab695637d629b0dfa71a48d8f457524/shared/p2p/negotiation.go#L23" target="_blank" rel="noopener noreferrer">existing peer negotiation</a> can be mostly reused. The key difference here is that we&#x27;ll need to maintain a peerstore abstraction where we keep track of the hello messages and potentially continuously update the peerstore abstraction with new values as we learn about them (TODO in a follow up design, as needed).</p><p>For a Agora-cl testnet implementation, we’ll set the fork version to the first 4 bytes of the deposit contract address. This will provide clear separation between testnet deployments.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="p2p-messages--protocol-registration"></a>P2P Messages / Protocol Registration<a class="hash-link" href="#p2p-messages--protocol-registration" title="Direct link to heading">#</a></h3><p>P2P message topic registration follows the same pattern we have today where the message type is hardcode mapped to the string protocol ID. The topic mapping is used for generic broadcasting implementation.</p><p>In the new p2p message paradigm, we will no longer send “announcement” type messages for propagation. Instead, the clients will send the full object for initial propagation. For example, a full block will be sent over GossipSub when it is created/propagated.</p><p>There are a few new p2p specific messages (without ssz tags):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">syntax </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;proto3&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message Hello </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    bytes fork_version </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// bytes4</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    bytes finalized_root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// bytes32</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token plain"> finalized_epoch </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    bytes head_root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// bytes32</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token plain"> head_slot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message Goodbye </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Reason reason </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// uint64</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    enum Reason </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        UNKNOWN </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        CLIENT_SHUTDOWN </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        IRRELEVANT_NETWORK </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        GENERIC_ERROR </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        reserved </span><span class="token number">4</span><span class="token plain"> to </span><span class="token number">127</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message BeaconBlocksRequest </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    bytes head_block_root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// bytes32</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token plain"> head_slot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token plain"> count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token plain"> step </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message BeaconBlocksResponse </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated eth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">BeaconBlock </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message RecentBeaconBlocksRequest </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated bytes block_roots </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// []bytes32, Array of hash tree roots.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong><em>Encoding Registration</em></strong>
In the p2p service, there will be an encoding protocol string mapping to an encoding.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> NetworkEncoding </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">DecodeTo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token builtin" style="color:rgb(189, 147, 249)">byte</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Encode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token builtin" style="color:rgb(189, 147, 249)">byte</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As part of the p2p constructor arguments, the p2p service will know which encoder to use at runtime. As part of the networking specification, it will either be ssz or ssz_snappy, but this design will allow flexibility for other encoding types. Once the encoding has been registered, it can be accessed by the regular sync topic middleware.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Encoding</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> NetworkEncoding</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The middleware can look up the type, initialize a pointer to an empty object of that type and pass the pointer with the network bytes to the encoding to hydrate the object from bytes by calling p2p.Encoding().DecodeTo(payload, to) where to is a newly initialized pointer. The logic here will look very similar to the logic that we see in <a href="https://github.com/zeroone-boa/agora-cl/blob/715b9cd5bab695637d629b0dfa71a48d8f457524/shared/p2p/service.go#L260" target="_blank" rel="noopener noreferrer">RegisterTopic</a> today.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="initial-sync"></a>Initial Sync<a class="hash-link" href="#initial-sync" title="Direct link to heading">#</a></h3><p>In this iteration of the networking design, initial synchronizing of a validator with an empty database will be similar to the sync workflow of Ethereum 1.0 where the node syncs from the genesis event. The workflow for initial sync will be as follows:</p><ul><li><ol><li>Determine the genesis state &amp; block by reading the ETH1 deposit contract logs from a proof-of-work Ethereum node.</li></ol></li><li><ol start="2"><li>Round-robin batch block sync with N peers from genesis to the last finalized epoch.</li></ol></li><li><ol start="3"><li>Process batch blocks upon each full epoch received.</li></ol></li><li><ol start="4"><li>Upon syncing with the last block in the finalized epoch, verify the roots are aligned with the received information on the finalized epoch.</li></ol></li><li><ol start="5"><li>Continue syncronization with the highest peer using fork choice rules and then resume with regular network syncronization.</li></ol></li></ul><p>The rationale for having step 4 is that we are guaranteed not to have forks or run fork choice rule until we reach the finalized epoch. After that time, we must run fork choice rule to determine the head of the chain.</p><p>Note that p2p Sends must wait for a maximum of TTFB_TIMEOUT (time to first byte) for the first response to come across the stream. The client will wait up to RESP_TIMEOUT to receive the full response from the stream.</p><p><strong>Open question:</strong> How frequently do we need to run fork choice in initial sync, after the finalized epoch? Only at the end of sync, at the end of each epoch, or every block processed?</p><p><strong>Answer:</strong> Run fork choice at the end of step 5, ensure the roots are as expected.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="handshake-initialization--hello-tracking"></a>Handshake Initialization &amp; Hello Tracking<a class="hash-link" href="#handshake-initialization--hello-tracking" title="Direct link to heading">#</a></h3><p>Peers are added to the peerstore from those that are discovered through our discovery protocol. Then Hello requests are sent to all peers which are in our peerstore and we wait for the corresponding hello responses from them. If the response doesn’t arrive in time(ex 5s), we disconnect from those peers. For those that respond with their own corresponding hello responses, we then validate their hello messages, if its invalid we then disconnect with them. If not we begin initial sync as described above.</p><p> Since sending and responding to hello requests is a core part of the initial handshake, we will have to use a connection handler, which performs this whenever we dial a peer or vice versa. This ensures that peers that connect to us and are able to propagate messages are only those that are validated according to the protocol</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">setupPeerHandShake</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">h host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> helloHandler sync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">RPCHandler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  h</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Notify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token plain">inet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">NotifyBundle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     ConnectedF</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">net inet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> conn inet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The above describes how we would handle the peer connection in the callback, we would validate each newly added peer using the hello rpc handler. This ensures any application logic stays in the sync package instead of the p2p package</p><p><strong>Round-Robin Batch Block Sync</strong></p><p>This sync mode requests subsets of the chain to multiple peers, perhaps even with some overlap in the future. The basic flow of this model of requests is to divide the requests evenly in round-robin fashion with peers. An important note to consider for batch syncronization is that a peer must enforce a maximum batch size defined in bytes (REQ_RESP_MAX_SIZE). The requesting client should not exceed this value when determining the batch sizes to request. At the time of writing this document, this value is to be determined. So, we’ll temporarily enforce a max count of 1 epoch worth of blocks. Using the maximum ssz encoded byte size of a block (1.122968 Mb), we can determine the max number of blocks to request to be within the size limit.</p><p>For example, if we were to request blocks 10 through 25 from 4 peers:</p><table><thead><tr><th><strong>Peer #</strong></th><th><strong>Batch Block Requests</strong></th></tr></thead><tbody><tr><td>Peer 1</td><td>10, 14, 18, 22</td></tr><tr><td>Peer 2</td><td>11, 15, 19, 23</td></tr><tr><td>Peer 3</td><td>12, 16, 20, 24</td></tr><tr><td>Peer 4</td><td>13, 17, 21, 25</td></tr></tbody></table><p><strong>Example Request for Peer 1</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    head_block_root</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> HashTreeRoot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    start_slot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    step</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the event that there is a failure for any subset of the requested range, the remaining blocks will be split across the remaining peers. For example, if peer 3 was disconnected without responding, we would round robin block requests for blocks [12, 24], [16], and [20].</p><table><thead><tr><th>Peer #</th><th>Batch Block Requests</th></tr></thead><tbody><tr><td>Peer 1</td><td>10, 14, 18, 22</td></tr><tr><td>Peer 2</td><td>11, 15, 19, 23</td></tr><tr><td>Peer 3</td><td>12, 16, 20, 24 (disconnected)</td></tr><tr><td>Peer 4</td><td>13, 17, 21, 25</td></tr><tr><td>Peer 1</td><td>12, 24</td></tr><tr><td>Peer 2</td><td>16</td></tr><tr><td>Peer 4</td><td>20</td></tr></tbody></table><p><strong>Edge case: Empty epoch / empty response (Not needed)</strong></p><p>In the event that we request blocks from a peer and receive an empty response, we may assume that this is an error initially and attempt the same request with a different peer. If multiple peers report the same empty response, we can assume this section of the chain contains “skip slots” where no block was produced. While this scenario may be unlikely for extended periods of time in the mainnet deployment, it is very likely in fragile test networks.</p><p><strong><em>Strategy one: retry with multiple other peers</em></strong></p><ul><li>Request 10, 14, 18, 22 from peer 1</li><li>Receive empty response</li><li>Request 10, 14, 18, 22 from peer 2, and 3</li><li>Process non-empty response from other peers or continue as skip blocks for that epoch</li></ul><p><strong><em>Strategy two: round robin the request to other peers</em></strong></p><ul><li>Request 10, 14, 18, 22 from peer 1</li><li>Receive empty response</li><li>Request 10, 22 from peer 2</li><li>Request 14 from peer 3</li><li>Request 18 from peer 4</li><li>Process non-empty response from other peers or continue as skip blocks for that epoch</li></ul><p><strong><em>Task:</em></strong> Discuss optimal strategy in design review</p><p><strong>Resolution: This section is not needed as clients should respond explicitly with errors.</strong></p><p><strong>TODO: How to handle slower peers</strong></p><p><strong>Initial Sync UX</strong></p><p>The user experience of initial sync should follow a design similar to Parity’s model of displaying interesting metrics as syncronization progresses.</p><p><strong>Regular Syncronization</strong></p><p>The current regular syncronization design is pretty much a giant <code>for select</code> block that just listens for incoming message announcements from peers, requests the full data, and sends the data over to its corresponding service for handling, such as attestations or blocks. This can be split up, as it is quite unorganized and messy. Current regular syncronization is also tasked with sending and announcing messages to peers in the network, not just receiving. Once again, that responsibility can also be split up for easier testing and readability of the API.</p><p>The code will be reorganized into a regular syncronization registry go file where all of the handlers are processed in the main select loop while each handler will exist in its own isolated go file. This pattern will avoid oversized files in the syncronization package.</p><p><strong>External RPC (Incoming Request Handling)</strong></p><p>The external RPC design implements the “Req/Resp” domain of the network specification. More specifically, the response part. The request part of the domain is covered in the next section, Internal API.</p><p>TODO: Consider rate limit requests.</p><p>Workflow for receiving an external RPC request:</p><ul><li>A new stream is opened with the appropriate protocol ID.</li><li>Context with timeout is set to TTFB_TIMEOUT (5s).</li><li>Request type is described in the protocol ID and looked up in the request type / protocol mapping.</li><li>Message is read until REQ_RESP_MAX_SIZE or the end of the message, whichever comes first.</li><li>Message payload is decoded using the strategy as indicated by the protocol ID.</li><li>Application hands the message to the appropriate regular sync handler with a reference to the existing stream.</li><li>Handler determines the appropriate response and responds on the already open stream.</li><li>Stream is closed.</li></ul><p>If a context has a timeout, the stream should be immediately closed, and a log emitted.
Probably at WARN or ERR level.</p><p>The method signature for a request handler would be:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> proto</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">libp2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Stream</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>These callback handlers are registered in beacon-chain/sync/handlers/registry.go and each handler must be self contained into its own go file within the handlers package. This isolation of handlers into their own go files keeps the project easier to navigate with tests closer to their implementation and average file lines of code reduced when possible.</p><p><strong><em>Handler: BeaconBlocks /eth2/beacon_chain/req/beacon_blocks/1/{ssz,ssz_snappy}</em></strong></p><p>Accepts a <em>pb.BeaconBlocksRequest message and responds with a </em>pb.BeaconBlocksResponse message. This handler will query the beacon database for blocks and respond as directed by the request query.</p><p><strong><em>Handler: BeaconBlocks /eth2/beacon_chain/req/recent_beacon_blocks/1/{ssz,ssz_snappy}</em></strong></p><p>Accepts a <em>pb.RecentBeaconBlocksRequest and responds with </em>pb.BeaconBlocksResponse message. This handler queries the beacon database for blocks by root and responds with the results.</p><p><strong><em>Handler: Hello /eth2/beacon_chain/req/hello/1/{ssz,ssz_snappy}</em></strong></p><p>Accepts a <em>pb.Handshake and responds with a </em>pb.Handshake. This handler will receive the handshake and compare it against their own. If the handshakes do not align as defined in the network specification, disconnect from the peer after responding with the handshake.</p><p><strong><em>Handler: Goodbye /eth2/beacon_chain/req/goodbye/1/{ssz,ssz_snappy}</em></strong></p><p>Accepts a *pb.Goodbye does not respond. This handler signals to the p2p library to remove said peer from the peerstore. The stream is closed immediately in this handler.</p><p><strong>GossipSub</strong></p><p>GossipSub as our pubsub library is mostly implemented already with the <a href="https://godoc.org/github.com/libp2p/go-libp2p-pubsub#GossipSubRouter" target="_blank" rel="noopener noreferrer">libp2p GossipSubRouter</a>. The majority of the work here is to ensure parameters are compatible with interoperability and protocols are aligned.</p><p><strong>Parameters</strong></p><table><thead><tr><th>Parameter Name</th><th>Description</th><th>Value</th></tr></thead><tbody><tr><td>D</td><td>Topic stable mesh target count</td><td>6</td></tr><tr><td>D_low</td><td>Topic stable mesh low watermark</td><td>4</td></tr><tr><td>D_high</td><td>Topic stable mesh high watermark</td><td>12</td></tr><tr><td>D_lazy</td><td>Gossip target</td><td>6</td></tr><tr><td>fanout_ttl</td><td>TTL for fanout maps for topics we are not subscribed to but have published to, in seconds</td><td>60</td></tr><tr><td>gossip_advertise</td><td>Number of windows to gossip about</td><td>3</td></tr><tr><td>gossip_history</td><td>Number of heartbeat intervals to retain message IDs</td><td>5</td></tr><tr><td>heartbeat_internal</td><td>Frequency of heartbeat, in seconds</td><td>1</td></tr></tbody></table><p>Conveniently, these values are the default for libp2p GossipSub. See <a href="https://godoc.org/github.com/libp2p/go-libp2p-pubsub#pkg-variables" target="_blank" rel="noopener noreferrer">godoc</a>. However, we should specify these within Agora-cl to avoid any upstream change breaking interoperability compatibility. Separating these values from hard coded constants will require an upstream PR as it is not configurable. Enabling this functionality can be a bounty and prioritized at P2/P3. At a minimum, we can write a unit test that would fail if any of these config&#x27;s change since the variables are public.</p><p><strong>Propagation: Message Validation</strong></p><p>Libp2p’s GossipSub implementation has the concept of <a href="https://godoc.org/github.com/libp2p/go-libp2p-pubsub#PubSub.RegisterTopicValidator" target="_blank" rel="noopener noreferrer">topic validators</a>. Registering topic validation would work for the type of validation that we require, however it would also require decoding the same message twice. The trade off is that the topic handler has less responsibility, but at a cost of duplicated efforts.</p><p><strong>Proposal 1: Use <a href="https://godoc.org/github.com/libp2p/go-libp2p-pubsub#PubSub.RegisterTopicValidator" target="_blank" rel="noopener noreferrer">PubSub.RegisterTopicValidator</a></strong></p><p><img alt="proposal1" src="/assets/images/proposal1-e0ce7749bc7c0f05f81661393dede2b0.png"></p><p>Built in functionality within the existing API will allow for arbitrary validation of incoming messages before automatically propagating to network peers. The benefit here is that the original message is relayed automatically with some knowledge of the originating message. In other words, the library could be clever enough not to propagate the message back to the originating peer.</p><p><strong>Proposal 2: Deny all validation in PubSub (selected proposal)</strong></p><p>A cost effective way to handle validation of message contents would be to register a validator that rejects everything by always returning “false” and shift this logic into the message handler. The handler will already have a decoded copy of the message and can check the contents for validity before calling Broadcast(msg) to propagate through the network. An alternative would be to registry a chain of adapters like we have in the current implementation.</p><p><img alt="proposal2" src="/assets/images/proposal2-75efc4f0940d7aaeee8be95f256179f1.png"></p><p><strong>GossipSub Message Handlers</strong></p><p>These handlers do not respond like the external RPC handlers. All handlers are expected to</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> proto</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>Open question:</strong> How does libp2p GossipSub implementation handle re-propagation? Is a message automatically re-propagated through the network or can some validation be checked before relaying the messages to peers?</p><p><strong>Handler: /eth2/beacon_block/{ssz,ssz_snappy}</strong>
Accepts a *pb.BeaconBlock. This topic is used for block propagation. The handler must validate the block signature is valid and immediately forward the message in GossipSub. The block may not process, but the trade off is that blocks can reach the edge of the network faster with the bare minimum validation. The handler will pass the beacon block through the same block processing that we have today.</p><p><strong>Handler: /eth2/beacon_attestation/{ssz,ssz_snappy}</strong>
Accepts a *pb.Attestation. The topic is used for attestation propagation. This handler must validate that the attestation votes on a valid block before forwarding the message through the network. Following that validation, the attestation processing will resume through the existing flow.</p><p><strong>Handler: /eth2/voluntary_exit/{ssz,ssz_snappy}</strong></p><p>Accepts a *pb.VoluntaryExit. This handler must verify that the exit passes the conditions within process_voluntary_exit before forwarding through the network. Following validation, the request is sent through the operations service for processing.</p><p><strong>Handler: /eth2/proposer_slashing/{ssz,ssz_snappy}</strong></p><p>Accepts a *pb.ProposerSlashing. This handler must verify the slashing passes the conditions with process_proposer_slashing before forwarding through the network. Following validation, the request is sent through the operations service for processing.</p><p><strong>Handler: /eth2/attester_slashing/{ssz,ssz_snappy}</strong></p><p>Accepts a *pb.AttesterSlashing. This handler must verify the slashing passes the conditions with process_attester_slashing before forwarding through the network. Following validation, the request is sent through the operations service for processing.</p><p><strong>Internal API (Outgoing Request Handling)</strong></p><p>The internal API is only concerned with broadcasting and the p2p. Send function should only be called from the regular sync service. Other services should accept a p2p.Broadcaster interface, or at least provide an implementation that prohibits use of Send. The Broadcast method should not change. It continues to accept a generic proto.Message which is used to look up the message topic mapping.</p><p>One thing to consider here is what encoding we should broadcast on. This should be controlled by a feature flag to specify encoding selection. The enum flag accepts ssz, ssz_snappy. The default will be ssz as required for interoperability. Ssz_snappy is the required field for mainnet. We must not support multiple encoding at runtime, as specified by the networking specification. Supporting multiple encodings would likely cause undue burden on the network and individual nodes.</p><p>Protocol buffers as encoding scheme would be an interesting effort to test in whiteblock framework. Adding another encoding strategy would be trivial to do, but we would need some evidence to support our case for one strategy over another. Networking specification requires SSZ for interoperability, at a minimum.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="discoveryv5"></a>DiscoveryV5<a class="hash-link" href="#discoveryv5" title="Direct link to heading">#</a></h2><p>For discovery we currently use Multicast DNS and Kademlia DHT. DiscV5 is roughly similar to how a kademlia DHT works. However instead of having keys and values stored, Node Records are stored and relayed to other peers. The protocol acts as a database for all live nodes in the network, with each node storing records of a small amount of peers.</p><p>An Ethereum Node Record which is defined <a href="https://eips.ethereum.org/EIPS/eip-778" target="_blank" rel="noopener noreferrer">here</a>, requires at least the IP address of the node and its UDP port.  In each of the node records stored, a node’s liveness is periodically validated, and if the node doesn’t respond its record is deleted.</p><p>On a positive note the reference implementation is in go over <a href="https://github.com/ethereum/go-ethereum/tree/master/p2p/discv5" target="_blank" rel="noopener noreferrer">here</a>, we wouldn’t have to implement it, since we can just use this version.</p><p>Discovery Communication is authenticated using session keys which are established in the handshake. There are different ways to save node records, either you could utilise an in-memory db for a temporary store or you could spin off a leveldb instance which can be persisted across sessions. For Agora-cl it would be easier for each node to simply have an in-memory db which  stores all the node records, we can look to have a persisted store for mainnet where we can analyse trade offs to this approach.</p><p><strong>Listening on a Port</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> discv5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ListenUDP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">priv </span><span class="token operator">*</span><span class="token plain">ecdsa</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">PrivateKey</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> conn conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> nodeDBPath </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> netrestrict </span><span class="token operator">*</span><span class="token plain">netutil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Netlist</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We listen on a UDP port for incoming messages from other nodes. This returns a network struct though which we can do this.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">network</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetFallbackNodes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">BootNode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This would set our provided bootnode as the fallback node since our in-memory database has no peers stored and therefore none to connect with yet, this populates the local table with all the node records stored in the bootnode. We would need to define a specific Topic for beacon nodes to communicate from, otherwise any peer using Discovery5 protocol would be our peer whether they are participating in Ethereum consensus or not. Topic Advertisement and Search would come up in peer discovery for shards where each node will accept topic registrations from other nodes for specific shards and then relay them to other nodes who are searching for specific shards. This is to provide a scalable and reasonably secure solution for sub-networks which cannot afford to have separate bootstrap nodes for each of those subnetworks.</p><p><strong>TODO: Add more detail of how to integrate into Agora-cl.</strong></p><p><strong>Fork Choice</strong></p><p>Regular sync service will be receiving either blocks or attestations. The block or attestation will get propagated to the block chain service methods <code>ReceiveBlock</code> and <code>ReceiveAttestation</code>. Those two methods call fork choice. From sync service’s point of view, fork choice is a black box.  In the example code below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rs </span><span class="token operator">*</span><span class="token plain">RegularSync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">receiveAttestation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">msg p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  resp </span><span class="token operator">:=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">pb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">AttestationResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  att </span><span class="token operator">:=</span><span class="token plain"> resp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Attestation</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Send att to blockchain service to run fork choice</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  If err </span><span class="token operator">:=</span><span class="token plain"> rs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">chainService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ReceiveAttestation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> att</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Send att to operation service for inclusion to attestation pool</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  rs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">operationService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IncomingAttFeed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">att</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rs </span><span class="token operator">*</span><span class="token plain">RegularSync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">receiveBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">msg p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  resp </span><span class="token operator">:=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">pb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">BlockResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  blk </span><span class="token operator">:=</span><span class="token plain"> resp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Block</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Send blk to blockchain service to run state transition and fork choice</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  If err </span><span class="token operator">:=</span><span class="token plain"> rs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">chainService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ReceiveBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> blk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>Migration strategy </strong></p><p>The changes outlined in this document will break the existing workflow for sync, this is unavoidable. The recommended workflow would be to first introduce the API changes, followed by introducing the new protobuf messages, then swapping out the underlying mechanics of each critical component (GossipSub, discovery, initial sync, peer handshakes, etc) without breaking any like-kind client networking in the master branch. In other words, any two clients at the same commit in the master branch should be able to operate a local or distributed network, but there are no backwards compatibility requirements or guarantees.</p><ul><li>Do not break the master branch!</li><li>Avoid any “mega” PRs!</li></ul><p><strong>Sync Migration: Initial &amp; Regular Sync</strong></p><p>Recommended migration strategy for sync is to refactor regular sync and initial sync package names to contain a deprecated_ prefix. This will allow for new code to be checked into master without causing issues and then the deprecated packages can be removed with the new packages wired up. This will be a breaking change at runtime in the sense that nodes before these changes will not be able to sync with the new protocol, but that is a trade off we can make as version 0.</p><p><strong>P2P Migration: Protocol/Topic Mappings</strong></p><p>Similar to the sync migration, the existing mapping will be prefixed with deprecated_ until that mapping can be removed and replaced with the new protocols/topics.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="additional-resources"></a>Additional Resources<a class="hash-link" href="#additional-resources" title="Direct link to heading">#</a></h2><ul><li><a href="https://github.com/ethereum/eth2.0-specs/blob/dev/specs/phase0/p2p-interface.md" target="_blank" rel="noopener noreferrer">Networking specification</a></li><li>Block max ssz encoded size = 1.122968 megabytes
excluding body = 368 bytes</li></ul><p>16<em>408 (prop slashing) = 6528
1</em>8488 (attester slashing) = 8488
128<em>8484 (attestation) = 1085952
16</em>1240 (deposit) = 19840
16*112 (voluntaryexit) = 1792</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/zeroone-boa/agora-cl-docs/edit/master/website/docs/devtools/net-design.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/devtools/init-state"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Initial synchronization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/devtools/extending-apis"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Extending APIs »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objective" class="table-of-contents__link">Objective</a></li><li><a href="#current-status-in-agora-cl" class="table-of-contents__link">Current Status in Agora-cl</a></li><li><a href="#detailed-design" class="table-of-contents__link">Detailed Design</a><ul><li><a href="#handshake--protocol-negotiation" class="table-of-contents__link">Handshake / Protocol Negotiation</a></li><li><a href="#p2p-messages--protocol-registration" class="table-of-contents__link">P2P Messages / Protocol Registration</a></li><li><a href="#initial-sync" class="table-of-contents__link">Initial Sync</a></li><li><a href="#handshake-initialization--hello-tracking" class="table-of-contents__link">Handshake Initialization &amp; Hello Tracking</a></li></ul></li><li><a href="#discoveryv5" class="table-of-contents__link">DiscoveryV5</a></li><li><a href="#additional-resources" class="table-of-contents__link">Additional Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_MyFc" href="/docs/getting-started"><img src="/img/Agora-cl.svg" alt="Agora-cl Docs" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/Agora-cl.svg" alt="Agora-cl Docs" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright © 2022 Bosagora, Validator Deposit Contract 0xXXX</div></div></div></footer></div>
<script src="/assets/js/runtime~main.bf2263fc.js"></script>
<script src="/assets/js/main.a87cd8b8.js"></script>
</body>
</html>