<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-139640266-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Agora-cl" href="/opensearch.xml">
<script src="https://buttons.github.io/buttons.js"></script><title data-react-helmet="true">Initial synchronization | Agora-cl</title><meta data-react-helmet="true" property="og:url" content="https://agora-cl-docs.bosagora.io/docs/devtools/init-state"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Initial synchronization | Agora-cl"><meta data-react-helmet="true" name="description" content="Overview of the Feature"><meta data-react-helmet="true" property="og:description" content="Overview of the Feature"><link data-react-helmet="true" rel="shortcut icon" href="/img/bosagora-logo.png"><link data-react-helmet="true" rel="canonical" href="https://agora-cl-docs.bosagora.io/docs/devtools/init-state"><link data-react-helmet="true" rel="alternate" href="https://agora-cl-docs.bosagora.io/docs/devtools/init-state" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://agora-cl-docs.bosagora.io/docs/devtools/init-state" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9b7cbe7b.css">
<link rel="preload" href="/assets/js/runtime~main.bf2263fc.js" as="script">
<link rel="preload" href="/assets/js/main.a87cd8b8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/getting-started"><img src="/img/bosagora-logo.png" alt="logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/bosagora-logo.png" alt="logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Agora-cl Documentation</b></a><a href="https://github.com/zeroone-boa/agora-cl/releases/tag/v3.1.1" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">agora_v3.1.1</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/install/install-with-script">Quick Install</a><a href="https://github.com/zeroone-boa/agora-cl" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://t.me/bosagora_eng" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1ZXk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started">Table of contents</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/install/install-with-script">Quickstart: Run a node</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/prepare-for-merge">Prepare for The Merge</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/security-best-practices">Security best practices</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/agora-cl-usage/parameters">Command-line options</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/monitoring/checking-status">Check node and validator status</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/troubleshooting/issues-errors">Troubleshooting</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Advanced installation guides</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">How-tos</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Developer wiki</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contribute/contribution-guidelines">Contribute to Agora-cl&#x27;s codebase</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contribute/golang-principles">Golang principles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reading/golang">Golang resources</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/reading/bazel">About Bazel</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">APIs</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Developer concepts</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/devtools/init-state">Initial synchronization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/devtools/net-design">Network design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/devtools/extending-apis">Extending APIs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/architecture-overview">Architecture overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/agora-cl node">Beacon node</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/agora-cl-validator-client">Validator client</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/validator-lifecycle">Validator lifecycle</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/optimistic-sync">Optimistic sync</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/validator-deposit-contract">Validator deposit contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/database-backend-boltdb">BoltDB database</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/p2p-networking">P2P networking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-agora-cl-works/bls-cryptography">BLS cryptography</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/devtools/end-to-end">End-to-end tests</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Misc</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq">Frequently asked questions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/terminology">Glossary</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Initial synchronization</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overview-of-the-feature"></a>Overview of the Feature<a class="hash-link" href="#overview-of-the-feature" title="Direct link to heading">#</a></h2><p><strong>What the feature is for:</strong></p><p>Initial sync serves the following purposes:</p><ul><li><p>Synchronizing from the last known node‚Äôs head (can be at genesis) to the highest finalized epoch known by the surrounding peers.</p></li><li><p>Synchronizing from the finalized checkpoint to the surrounding peers‚Äô best known non-finalized epoch.</p></li><li><p>Fallback synchronization mechanism when node falls behind its peers while performing the regular synchronization.</p></li></ul><p><strong>Where the feature lives in Agora-cl:</strong> The feature is fully contained within the following folder/package: <a href="https://github.com/zeroone-boa/agora-cl/tree/develop/beacon-chain/sync/initial-sync" target="_blank" rel="noopener noreferrer">/beacon-chain/sync/initial-sync/</a></p><p><strong>Technologies used:</strong> <a href="https://github.com/libp2p/go-libp2p" target="_blank" rel="noopener noreferrer">go-libp2p</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="design-overview"></a>Design Overview<a class="hash-link" href="#design-overview" title="Direct link to heading">#</a></h2><p>What problems are being addressed:</p><p>The challenges for the initial sync implementers can be summarized as the following;</p><ul><li><p>Peers surrounding the node can be bogus, non-responsive or even evil (that‚Äôs serving incoherent or wrong data on purpose). The trick is to make sure that blocks are being processed at a high pace, with good peers utilized to the fullest without danger of being eclipsed i.e. whether peer is considered good/bad is highly dependent on context and is dynamic in nature, so peer status should be updated regularly and a bad peer now may be a good choice to fetch from at some future moment.</p></li><li><p>Incoming block list is sequential, but in order to utilize available resources better and increase throughput, we need to fetch data concurrently. That can be redundant at times, and it is important to make sure that block processors are not caught in livelock (where they are just spinning on the very same redundant data), nor starving (when they are processing blocks at a higher pace than block fetchers are capable of providing).</p></li><li><p>When it comes to the non-finalized part of the chain, everything becomes a bit more complicated: at this point node‚Äôs known head is not finalized, thus can be changed, and initial sync algorithms should be aware of this (and re-request some previous range if necessary). This capability becomes crucial when it comes to long periods of non-finality where it‚Äôs critically important to allow nodes to synchronize to the highest epoch possible, yet backtrack (if necessary) to some previous ancestor to allow fork choice to select another branch to build upon.</p></li><li><p>Blocks are created during time slots, but some slots might have skipped/missing blocks, and the synchronization routine must be capable of finding the next non-skipped slot even if the gap is measured in thousands of slots.</p></li><li><p>Sometimes (especially exacerbated during long periods of non-finality) nodes can get stuck in an unfavourable fork, the synchronization routine must have capability to backtrack and explore other forks, ideally without too much time spent on spinning in that unfortunate fork.</p></li><li><p>Whenever there‚Äôs a problem with regular synchronization, initial synchronization serves as a fallback mechanism to catch up on peers. Therefore, it must be robust enough to proceed in spite of problems that caused the node to fall behind the peers in the first place.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="high-level-design-of-the-solution"></a>High Level Design of the Solution<a class="hash-link" href="#high-level-design-of-the-solution" title="Direct link to heading">#</a></h2><p>Essentially synchronization is split into two phases: from the state at which the node is started to the finalized checkpoint (as reported by majority of peers) and, then, if necessary, from that finalized checkpoint till the best known state (we have a minimum number of peers that are expected to support that state, before considering synchronization toward that head).</p><p>Both described phases utilize the very same synchronization mechanism: queue of blocks, which guarantees that incoming blocks will be in sequential order, block processors will never starve (the queue will always have some blocks waiting), and that with acceptable amount of redundant requests queue avoids livelocks by providing blocks that are capable of advancing the state.</p><p>To keep track of the state, the queue utilizes finite state machines (FSMs): blocks are requested in batches, with each batch range of blocks assigned to one of available state machines, and within queue there‚Äôs a ticker that is constantly checking the state of each individual machine allowing them to apply actions to deterministically transit into the next state:</p><p><strong>State(S) x Event(E) -&gt; Actions (A), State(S&#x27;)</strong></p><p>(here E - is normally a tick event, and actions are selected from available event handlers depending on the initial state S).</p><p>FSMs are responsible for managing state transitions (fetch request queued, block batch requested, blocks received, data processed etc), but the actual fetching of data is handled by another major component of the init-sync system: block fetcher. This is done to decouple block queuing and actual block fetching: different state machines request different ranges concurrently. Of course, this may end up in some redundancy (when the earliest machine‚Äôs blocks are on some wrong fork and the next FSMs cannot proceed without resetting and re-requesting data of that first machine).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="service-design-diagram"></a>Service Design Diagram<a class="hash-link" href="#service-design-diagram" title="Direct link to heading">#</a></h2><p><img alt="Service Diagram" src="/assets/images/service-diagram-49915f4242c300f1598ccce3a652b332.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fsm-state-transitions-diagram"></a>FSM State Transitions Diagram<a class="hash-link" href="#fsm-state-transitions-diagram" title="Direct link to heading">#</a></h2><p><img alt="FSM State Transitions Diagram" src="/assets/images/fsm-state-trans-f1240ebbeea271147b7babb1be082be4.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="architectural-overview"></a>Architectural Overview<a class="hash-link" href="#architectural-overview" title="Direct link to heading">#</a></h2><p><strong>Structure of the feature (is it a service, a tool, a background routine?)</strong></p><p><em>Initial synchronization is implemented as a separate service, loadable into service registry.</em></p><p><strong>Components of the feature</strong></p><p>Initial Synchronization Service</p><p>Available synchronization functionality is exposed via <code>initalsync.Service</code>, with two major methods: <code>Start()</code> and <code>Resync()</code>. The former is responsible for initialization of the service and the first synchronization after the node‚Äôs initial start and the latter is called when Agora node falls behind during the normal synchronization, and needs to resync using a more robust initial synchronization mechanism.</p><p>Another purpose of the service object is to be the glue between blocks queue and blocks processor: it makes sure that the queue is started and blocks received are forwarded to the processor.</p><p>See: <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/service.go#L46" target="_blank" rel="noopener noreferrer">service.go</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/develop/beacon-chain/sync/initial-sync/round_robin.go" target="_blank" rel="noopener noreferrer">round_robin.go</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="blocks-queue"></a>Blocks Queue<a class="hash-link" href="#blocks-queue" title="Direct link to heading">#</a></h3><p>Blocks queue is the core component managing higher level block fetching from the surrounding peers.</p><p>Queue operates in the following manner:</p><ul><li><p>When started, queue creates the internal fetcher service, which is responsible for lower level data fetching functionality i.e. queue manages the overall scheduling process, while blocks fetcher is responsible for talking to peers, requesting and processing their data (see <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L100" target="_blank" rel="noopener noreferrer">blocks_queue.go:newBlocksQueue</a>. Block fetcher exposes the output channel which the queue keeps waiting on up until all the necessary blocks are fetched, at that point the queue closes the fetcher&#x27;s context thus closing that sub-service as well see: <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L255" target="_blank" rel="noopener noreferrer">blocks_queue.go:loop</a>.</p></li><li><p>In order to keep FSMs as lightweight as possible, queue registers event handlers with itself instead of registering them with each individual machine. Each handler function accepts FSM as an argument (thus event handlers are fully aware on which machine they operate on).</p></li><li><p>Queue relies on the FSM manager to create/remove FSMs. In order to allow concurrent scheduling of different batches of blocks, queue relies on several machines (currently 8). FSMs are used to track the state of different block request ranges (whether blocks in that range have been requested, already fetched, sent down the pipeline etc).</p></li><li><p>Once the fetcher is initialized and event handlers are registered, the queue enters an event listening <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L165" target="_blank" rel="noopener noreferrer">loop</a>, with only two available event types: <code>Tick</code> and <code>Data Received</code>. The <code>Tick</code> event is nothing more than a time ticker triggering different events handlers on FSMs (depending on their current state) on a regular basis (currently every 200 milliseconds). The <code>Data received</code> event is triggered asynchronously on read from the output channel of the fetcher i.e. when the fetcher returns some data to parse and pass over to block processors.</p></li></ul><p><strong>Available events handlers:</strong></p><ul><li><p><em>On schedule:</em> this event handler is triggered when a <code>Tick</code> event occurs on a machine in a <code>New</code> state.</p></li><li><p><em>On data received:</em> this event handler is triggered when a <code>Data Received</code> event occurs on a machine (if machine is not in <code>Scheduled</code> state, incoming data is ignored).</p></li><li><p><em>On ready to send:</em> this event handler is triggered when a <code>Tick</code> event occurs on a machine with <code>Data Parsed</code> state i.e. machine that has incoming data placed into it.</p></li><li><p><em>On a stale machine:</em> this event handler is triggered when a <code>Tick</code> event occurs on an unresponsive machine, the main purpose of this handler is to mark the machine as skipped, so that <code>On a skipped machine</code> handler resets it.</p></li><li><p><em>On a skipped machine:</em> this event handler is triggered when a <code>Tick</code> event occurs on a stuck machine, that&#x27;s a machine that stays in a given state for too long, and is marked as <code>Skipped</code>, this handler is responsible for resetting such machines.</p></li></ul><p>See: <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L73" target="_blank" rel="noopener noreferrer">blocks_queue.go</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L281" target="_blank" rel="noopener noreferrer">Queue.onScheduleEvent()</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L299" target="_blank" rel="noopener noreferrer">Queue.onDataReceivedEvent()</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L334" target="_blank" rel="noopener noreferrer">Queue.onReadyToSendEvent()</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L383" target="_blank" rel="noopener noreferrer">Queue.onProcessSkippedEvent()</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L442" target="_blank" rel="noopener noreferrer">Queue.onCheckStaleEvent()</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fsm-manager-and-fsms"></a>FSM Manager and FSMs<a class="hash-link" href="#fsm-manager-and-fsms" title="Direct link to heading">#</a></h3><p>Each FSM <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/fsm.go#L43" target="_blank" rel="noopener noreferrer">(see fsm.go:stateMachine)</a>  has the following data associated with it:</p><p><strong>Start Slot:</strong> beginning of the range of blocks to pull into a given machine. The end slot is determined by the batch size, which is a predefined constant (currently 64).</p><p><strong>Peer ID:</strong> identifies a peer that was used to fetch blocks into a given state machine; provided by fetcher via its output channel.</p><p><strong>Blocks:</strong> fetched blocks; provided by the fetcher via its output channel.</p><p>FSM Manager is a container used to group machines together, for easier management and traversal. It is queue‚Äôs responsibility to make sure that <code>Start Slot</code> uniquely identifies the machine: there‚Äôs no point in having a machine with the same start slots, as machines are fetching batches of a constant size starting from the start slot, therefore machines with the same start slot will essentially fetch the same block range (albeit, possibly, from the different peers). Of course sometimes such a redundancy is unavoidable: in cases when the Agora node‚Äôs head cannot be advanced, machines with slots equal to that of some previously used machines can be spawned (see how machines are reset in <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L419" target="_blank" rel="noopener noreferrer">onProcessSkippedEvent()</a> event handler).</p><p>While event handlers operate on FSMs, they are not registered with machines themselves but with the queue, this is done for reasons of efficiency (machines are constantly removed and re-added, so are kept as simple as possible). When an event occurs (for example <code>Tick</code> event occurs every 200 milliseconds), each known FSM is passed to the corresponding event handler, depending on FSM‚Äôs current state. Here is the list of event handlers, required FSM start states and their corresponding handlers:</p><table><thead><tr><th>Event</th><th>Required FSM state</th><th>Event Handler</th></tr></thead><tbody><tr><td>Tick</td><td>New</td><td><a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L281" target="_blank" rel="noopener noreferrer">Queue.onScheduleEvent()</a></td></tr><tr><td>Tick</td><td>Data parsed</td><td><a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L334" target="_blank" rel="noopener noreferrer">Queue.onReadyToSendEvent()</a></td></tr><tr><td>Tick</td><td>Skipped</td><td><a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L383" target="_blank" rel="noopener noreferrer">Queue.onProcessSkippedEvent()</a></td></tr><tr><td>Tick</td><td>Sent</td><td><a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L442" target="_blank" rel="noopener noreferrer">Queue.onCheckStaleEvent()</a></td></tr><tr><td>Data Received</td><td>Scheduled</td><td><a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L299" target="_blank" rel="noopener noreferrer">Queue.onDataReceivedEvent()</a></td></tr></tbody></table><p>The above table is easy to read: for example it is easy to see that in order for an FSM to be passed to <code>onDataReceivedEvent()</code> handler, it must be in a <code>Scheduled</code> state and <code>Data Received</code> event must occur (that‚Äôs fetcher should write something into its output channel).</p><p>Below is a state transition table (depending on input there might be several possible transitions for a given event -- only one of which is valid, as our FSMs are deterministic):</p><table><thead><tr><th>State/Event</th><th>New</th><th>Scheduled</th><th>Data Parsed</th><th>Skipped</th><th>Data Sent</th></tr></thead><tbody><tr><td><strong>Tick</strong></td><td>Scheduled Skipped</td><td></td><td>Data Sent Skipped</td><td>New</td><td>New Skipped</td></tr><tr><td><strong>Data Received</strong></td><td></td><td>Data Parsed New</td><td></td><td></td><td></td></tr></tbody></table><p>Refer to <a href="#fsm-state-transitions-diagram">FSM state transitions diagram</a> for further details.</p><p>See: <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/fsm.go#L35" target="_blank" rel="noopener noreferrer">fsm.go:stateMachineManager</a></p><p><strong>Machines lifetime</strong></p><p>When queue operates, FSMs are constantly being created and removed:</p><ul><li>Whenever a queue has less than a <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L31" target="_blank" rel="noopener noreferrer">predefined</a> number of machines (currently 8), a new machine is added.</li><li>Once a machine is outdated (its data is processed, or it features a block range that has already been passed by the currently known head, or it is in a stuck or invalid state), it is removed from the FSM manager.</li></ul><p>This is done to optimize the runtime and make code more simple to understand (had we decided to reuse the machines it would have required a lot of orchestration code - but right now, queue implementation is very simple and gets the job done).</p><p>So, whenever we need to implement some complex algorithm it almost always has to do with creating a new state machine of a particular configuration. For instance, see <a href="#handling-skipped-blocks">Handling Skipped Slots section</a> and how finding the first non-skipped slot is implemented using a machine with a start slot set to some high future epoch.</p><p>Being able to algorithmically select a range of blocks (which will be reset if stuck, and if it gets blocks, those blocks will be eventually pushed into the queue and towards the block processors -- automatically) is one of the main benefits of using FSMs.</p><p>See: <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue_utils.go#L11" target="_blank" rel="noopener noreferrer">blocks_queue_utils.go:resetFromFork()</a> and <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue_utils.go#L44" target="_blank" rel="noopener noreferrer">blocks_queue_utils.go:resetFromSlot()</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="blocks-fetcher"></a>Blocks Fetcher<a class="hash-link" href="#blocks-fetcher" title="Direct link to heading">#</a></h3><p>The fetcher component (see <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue_utils.go#L44" target="_blank" rel="noopener noreferrer">blocks_fetcher.go:blocksFetcher</a>) is responsible for handling p2p communication, and does the actual data requesting and fetching. It is a very simple component operating in the following way:</p><ul><li><p>Fetcher manages two channels: one for incoming fetching requests and the other for sending fetched data back to requesters. All this is done asynchronously, of course!</p></li><li><p>Fetcher is smart enough to honour rate limits and while being highly concurrent, never requests at a higher pace than is allowed by Agora-cl beacon nodes (see <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_fetcher_peers.go#L21" target="_blank" rel="noopener noreferrer">getPeerLock()</a>). So, fetching nodes should never receive a bad score from fellow Agora-cl peers (while it is theoretically possible that other clients still consider our fetcher aggressive, in reality Agora-cl has one of the strictest limits, thus in practice this has never happened).</p></li><li><p>All the low level details (like checking that enough peers are available, filtering out less useful peers, handling p2p errors) of data requesting is abstracted within the fetcher service.</p></li></ul><p>See: <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_fetcher.go#L68" target="_blank" rel="noopener noreferrer">blocks_fetcher.go</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_fetcher_peers.go#L1" target="_blank" rel="noopener noreferrer">blocks_fetcher_peers.go</a>, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_fetcher_utils.go#L1" target="_blank" rel="noopener noreferrer">blocks_fetcher_utils.go</a></p><p><strong>Noteworthy code in the feature</strong></p><p>There are several very interesting add-ons to the main synchronization procedure, making it more robust and useful. In this section, we will briefly cover them (feel free to dive into the code deeper -- it should be easy to follow).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="backtracking-procedure"></a>Backtracking procedure<a class="hash-link" href="#backtracking-procedure" title="Direct link to heading">#</a></h3><p>Normally, there are no more than a handful of non-finalized epochs, and once initial synchronization is complete, the regular synchronization is capable of proceeding by obtaining new blocks, validating them, and applying fork-choice rule. But occasionally, the whole network is unable to reach consensus and forked branches start to occur, and can even get quite long. This is especially prevalent during test networks (see <a href="https://medium.com/prysmatic-labs/eth2-medalla-testnet-incident-f7fbc3cc934a" target="_blank" rel="noopener noreferrer">Medalla Incident</a> post-mortem), where there‚Äôs no real ether at stake.</p><p>Regular synchronization cannot handle such fork branching, and node eventually falls behind the highest expected slot (if counting time slots from the genesis up to the current clock time). Once that happens, the system falls back to initial synchronization, which needs to be able to not only synchronize with the majority of  known peers, but handle the case when that majority is dynamic i.e. be capable to backtrack from some unfavourable fork, which is no longer voted for by the current majority of known peers (while it was supported by previous majority just 10 minutes ago!).</p><p>Our backtracking algorithm is pretty simple (code is abridged, see full version <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_fetcher_utils.go#L1470" target="_blank" rel="noopener noreferrer">here</a>:)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// findFork queries all peers that have higher head slot, in an attempt to find</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// ones that feature blocks from alternative branches. Once found, peer is</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// further queried to find a common ancestor slot.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">f </span><span class="token operator">*</span><span class="token plain">blocksFetcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">findFork</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> slot </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">forkData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// some details are skipped..</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Select peers that have a higher head slot, and potentially blocks</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// from a more favourable fork.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> peers </span><span class="token operator">:=</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">BestNonFinalized</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> epoch</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Shuffle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> j </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">j</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Query all found peers, stop on peer with alternative blocks,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// and try backtracking.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> pid </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">range</span><span class="token plain"> peers </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fork</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">findForkWithPeer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> pid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> slot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">continue</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> fork</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> errNoPeersWithAltBlocks</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Essentially, all we are doing is querying our peer list for peers with a non-finalized known slot higher than that which our node was able to progress to. Then, out of those peers, the peers list is randomized and they are queried to find a peer with blocks our node hasn‚Äôt as yet seen. Once such a peer is found, we need to backtrack (hence the name!) on that peer from the slot starting at our node‚Äôs head backwards in history until the common ancestor block is found (or until the predefined limit is reached, to avoid infinite/overly long loops). Once a common ancestor is found, node tries to build on top of that alternative fork. While seemingly trivial, this procedure has worked extremely well.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="handling-skipped-blocks"></a>Handling skipped blocks<a class="hash-link" href="#handling-skipped-blocks" title="Direct link to heading">#</a></h3><p>At each slot a block can be proposed. If this doesn‚Äôt happen, the block is considered as skipped. There might be lots of consecutive skipped blocks, but our queue has only 8 FSMs (so, can look no further than 8x64 = 512 blocks ‚Äúinto the future‚Äù). How do you overcome such a limitation, where the normal queue range of vision is 512 next slots, and the first non-skipped block is 10K+ slots away?</p><p>A simple trick is used: when all machines are in <code>Skipped</code> state, meaning we are stuck, the first 7 machines are reset normally (<strong>the first machine&#x27;s starting slot is the current known head slot, the second machine is +64 slots, and so on, and so forth</strong>), but the last state machine is reset from a slot, possibly very far in future, where the first non-skipped block is found. So, if the last machine is set to start fetching within range where the next non-skipped block lives, then it will be able to fetch that block, and thus advance our node‚Äôs head slot. The only problem is finding that starting slot for this last FSM, and doing so efficiently i.e. without simply querying each and every slot up until we find a non-empty one (which can be 10K+ slots away).</p><p>We‚Äôve devised an algorithm that is capable of looking ahead 50K+ slots (instead of only 512), and even further (for 50K we have unit tests proving the statement):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">nonSkippedSlotAfter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">slot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    head </span><span class="token operator">:=</span><span class="token plain"> chain head on which peers agree </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">we filter and shuffle peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    check fist n </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">currently n </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> epochs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> fully</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> slot by slot</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> non</span><span class="token operator">-</span><span class="token plain">skipped slot found </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> not then resort to random sampling</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> every epoch in </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">slot</span><span class="token operator">+</span><span class="token plain">n</span><span class="token operator">*</span><span class="token number">32</span><span class="token plain"> to best known head</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">select</span><span class="token plain"> and check random slot </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">one </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> each epoch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> slot is non</span><span class="token operator">-</span><span class="token plain">skipped log it and </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">break</span><span class="token plain"> out of the loop</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    with found non</span><span class="token operator">-</span><span class="token plain">skipped slot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        find surrounding epochs and pull all the blocks</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">to find the first non</span><span class="token operator">-</span><span class="token plain">skipped slot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        when block with slot </span><span class="token operator">&gt;</span><span class="token plain"> than argument slot is found</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> it</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And the corresponding implementation can be found in <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_fetcher_utils.go#L34" target="_blank" rel="noopener noreferrer">blocks_fetcher_utils.go:nonSkippedSlotAfter</a>, here it signature:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// nonSkippedSlotAfter checks slots after the given one in an attempt to find</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// a non-empty future slot.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// For efficiency only one random slot is checked per epoch, so returned slot</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">//  might not be the first non-skipped slot. This shouldn&#x27;t be a problem, as</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// in case of adversary peer, we might get incorrect data anyway, so code that</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// relies on this function must be robust enough to re-request, if no progress</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// is possible with a returned value.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">f </span><span class="token operator">*</span><span class="token plain">blocksFetcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">nonSkippedSlotAfter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">slot </span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The procedure is quite optimized, for instance, within a single request, node samples 16 future epochs are at once (so the pace is 16x32=512 blocks/request, when looking for a non-skipped slot). Hence even non-skipped slots which are significantly in the futre are found very quickly.</p><p>See: <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue.go#L383" target="_blank" rel="noopener noreferrer">blocks_queue.go:onProcessSkippedEvent()</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="utilizing-peer-scorer"></a>Utilizing peer scorer<a class="hash-link" href="#utilizing-peer-scorer" title="Direct link to heading">#</a></h3><p>Since we are dealing with a public decentralized network, we cannot assume that each peer behaves correctly, and there might be bogus, unresponsive, or even malicious peers.</p><p>In order to avoid being stuck with a single unresponsive peer, our first fetcher implementation shuffled peers before selecting one to fetch data from. We have improved upon this method and now score peers on their behaviour and increase the probability of selecting high scoring peers, thus utilizing our mesh more efficiently.</p><p>We have quite sophisticated scoring mechanisms already in place, and we‚Äôre <a href="https://github.com/zeroone-boa/agora-cl/issues/6622" target="_blank" rel="noopener noreferrer">continuingly</a> building on them. Currently, the peer scorer service is able to track peer‚Äôs performance (on how many requests, how many useful blocks -- that‚Äôs blocks advancing the head -- have been returned). Peers scoring higher will have a better chance of being selected (see <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_fetcher_peers.go#L94" target="_blank" rel="noopener noreferrer">blocks_fetcher_peers.go</a> for full code):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// filterPeers returns a transformed list of peers, weight sorted by scores</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// and capacity remaining.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// List can be further constrained using peersPercentage, where only</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// percentage of peers are returned.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">f </span><span class="token operator">*</span><span class="token plain">blocksFetcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">filterPeers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">...</span><span class="token plain"> peers </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">peer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> peersPercentage </span><span class="token builtin" style="color:rgb(189, 147, 249)">float64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">peer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ID </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Sort peers using both block provider score and, custom, capacity</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// based score (see peerFilterCapacityWeight if you want to give</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// different weights to provider&#x27;s and capacity scores).</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Scores produced are used as weights, so peers are ordered</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// probabilistically i.e. peer with</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// a higher score has a higher chance to end up higher in the list.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    scorer </span><span class="token operator">:=</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Scorers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">BlockProviderScorer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    peers </span><span class="token operator">=</span><span class="token plain"> scorer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">WeightSorted</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        peerID peer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> blockProviderScore </span><span class="token builtin" style="color:rgb(189, 147, 249)">float64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">float64</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        remaining</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> capacity </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">float64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rateLimiter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Remaining</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">peerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">float64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rateLimiter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Capacity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// When capacity is close to exhaustion, allow less performant peers</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">// to take a chance.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// Otherwise, there&#x27;s a good chance the system will be forced to</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)">// wait for the rate limiter.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> remaining </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">float64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">blocksPerSecond</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token number">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        capScore </span><span class="token operator">:=</span><span class="token plain"> remaining </span><span class="token operator">/</span><span class="token plain"> capacity</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        overallScore </span><span class="token operator">:=</span><span class="token plain"> blockProviderScore</span><span class="token operator">*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1.0</span><span class="token operator">-</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">capacityWeight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> capScore</span><span class="token operator">*</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">capacityWeight</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Round</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">overallScore</span><span class="token operator">*</span><span class="token plain">scorers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ScoreRoundingFactor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> scorers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ScoreRoundingFactor</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">trimPeers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> peersPercentage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Not only do we filter by score, we also take into account the remaining capacity of a peer (capacity being the number of blocks left, before the rate limiter will be triggered and requests to the peer are blocked for a short period of time until capacity is restored).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="testing"></a>Testing<a class="hash-link" href="#testing" title="Direct link to heading">#</a></h2><p><strong>Unit tests and mocks, how to write tests for the feature:</strong>
Since initial synchronization interacts heavily with the P2P layer, we rely on mocks to simulate network mesh. The easiest way to start the test is to use <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/initial_sync_test.go#L74" target="_blank" rel="noopener noreferrer">initializeTestServices()</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Get chain, network, and database objects.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// You can provide blocks of your node as a second param.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Surrounding peers are defined in the third param.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> db </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">initializeTestServices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token builtin" style="color:rgb(189, 147, 249)">uint64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">*</span><span class="token plain">peerData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>See, <a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue_test.go#L134" target="_blank" rel="noopener noreferrer">TestBlocksQueue_Loop()</a> as an example of testing block syncing as a whole.</p><p>If you need more control on node‚Äôs known state, or on peer‚Äôs known state, we also have the following helper methods for that:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Setup database:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">beaconDB </span><span class="token operator">:=</span><span class="token plain"> dbtest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetupDB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Setup network layer:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">p2p </span><span class="token operator">:=</span><span class="token plain"> p2pt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewTestP2P</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Setup Agora chain sequence (128 blocks):</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">chain </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">extendBlockSequence</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">*</span><span class="token plain">eth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SignedBeaconBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">128</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">genesisBlock </span><span class="token operator">:=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NoError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> beaconDB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SaveBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Background</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> genesisBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">genesisRoot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> genesisBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Block</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HashTreeRoot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NoError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Initialize beacon state:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">st </span><span class="token operator">:=</span><span class="token plain"> testutil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewBeaconState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mc </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">mock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ChainService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    State</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Root</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  genesisRoot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">    beaconDB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FinalizedCheckPoint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">eth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Checkpoint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Epoch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> finalizedEpoch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Root</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token function" style="color:rgb(80, 250, 123)">byte</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Sprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;finalized_root %d&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> finalizedEpoch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, you‚Äôre able to populate node‚Äôs chain with any blocks you need (including forked or skipped ones):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Populate database with blocks with part of the chain,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// orphaned block will be added on top.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> blk </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">range</span><span class="token plain"> chain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">84</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    parentRoot </span><span class="token operator">:=</span><span class="token plain"> bytesutil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ToBytes32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">blk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Block</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ParentRoot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Save block only if the parent root is already in the database or cache.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> beaconDB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HasBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> parentRoot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> mc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HasInitSyncBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">parentRoot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NoError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> beaconDB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SaveBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> blk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NoError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetSlot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">blk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Block</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Slot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Finally, time to configure peer‚Äôs blocks:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">finalizedSlot </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">uint64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">82</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">finalizedEpoch </span><span class="token operator">:=</span><span class="token plain"> helpers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SlotToEpoch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">finalizedSlot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Connect peer that has all the blocks available. You can have a peer with</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// forked or missed blocks -- just update the chain param.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">allBlocksPeer </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">connectPeerHavingBlocks</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> finalizedSlot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">defer</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetConnectionState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">allBlocksPeer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> peers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">PeerDisconnected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Since we have prepared (and customized) all the necessary mocks, time to setup queue and fetcher services:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><pre tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Setup fetcher:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">fetcher </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">newBlocksFetcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">&amp;</span><span class="token plain">blocksFetcherConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        chain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">   p2p</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        db</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">    beaconDB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">fetcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rateLimiter </span><span class="token operator">=</span><span class="token plain"> leakybucket</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewCollector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">6400</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">6400</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Queue should be able to fetch the whole chain.</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">queue </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">newBlocksQueue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">blocksQueueConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    blocksFetcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">       fetcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    chain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">               mc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    highestExpectedSlot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">uint64</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">len</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">chain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    mode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">                modeNonConstrained</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For even better illustration on customized setups, please, see the following tests:</p><ul><li><a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue_test.go#L134" target="_blank" rel="noopener noreferrer">TestBlocksQueue_stuckWhenHeadIsSetToOrphanedBlock()</a></li><li><a href="https://github.com/zeroone-boa/agora-cl/blob/ce397ce797c33dbcf77fa7670c356844ef6aad43/beacon-chain/sync/initial-sync/blocks_queue_test.go#L1026" target="_blank" rel="noopener noreferrer">TestBlocksQueue_stuckInUnfavourableFork()</a></li></ul><p><strong>Runtime testing and usage</strong></p><p>To run unit tests using bazel:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">bazel test //beacon-chain/sync/initial-sync:go_default_test --test_arg=-test.v --test_output=streamed --test_arg=-test.failfast --nocache_test_results --test_filter=</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>--test_filter</code> can be empty (all tests will then be run), or specify a pattern to match:</p><table><thead><tr><th>--test_filter</th><th>Component to be tested</th></tr></thead><tbody><tr><td>TestBlocksQueue</td><td>All blocks queue tests.</td></tr><tr><td>TestBlocksFetcher</td><td>All blocks fetcher tests.</td></tr><tr><td>TestStateMachine</td><td>All FSM related tests.</td></tr><tr><td>TestService</td><td>All init-sync service tests.</td></tr></tbody></table><p>To run tests using vanilla Go, just use <code>go test</code> (to understand the reasons for passing the <code>develop</code> tag see our <a href="https://github.com/zeroone-boa/agora-cl/blob/develop/DEPENDENCIES.md#running-tests" target="_blank" rel="noopener noreferrer">DEPENDENCIES</a>):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">go test ./beacon-chain/sync/initial-sync -v -failfast -tags develop -run TestBlocksQueue</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When it comes to system and integration testing, generally one is expected to do it manually: run the Agora node and see whether it was able to sync from genesis to the latest head.</p><p>Variations include: stopping and restarting, stopping for a long time and then restarting, switching off access to the internet etc etc. Here is one way to do it:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Remove previous data:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">rm -r ~/agora-cl/beaconchaindata ~/agora-cl/network-keys</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Assuming you have geth node running locally, run init-sync on testnet</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bazel run //beacon-chain -- --datadir=$HOME/agora-cl  \</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --verbosity=debug \</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --p2p-max-peers=500 \</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --execution-endpoint=$HOME/Library/Ethereum/testnet/geth.ipc \</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --enable-debug-rpc-endpoints --testnet</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/zeroone-boa/agora-cl-docs/edit/master/website/docs/devtools/init-state.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/how-agora-cl-works/keymanager-api"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Keymanager APIs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/devtools/net-design"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Network design ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview-of-the-feature" class="table-of-contents__link">Overview of the Feature</a></li><li><a href="#design-overview" class="table-of-contents__link">Design Overview</a></li><li><a href="#high-level-design-of-the-solution" class="table-of-contents__link">High Level Design of the Solution</a></li><li><a href="#service-design-diagram" class="table-of-contents__link">Service Design Diagram</a></li><li><a href="#fsm-state-transitions-diagram" class="table-of-contents__link">FSM State Transitions Diagram</a></li><li><a href="#architectural-overview" class="table-of-contents__link">Architectural Overview</a><ul><li><a href="#blocks-queue" class="table-of-contents__link">Blocks Queue</a></li><li><a href="#fsm-manager-and-fsms" class="table-of-contents__link">FSM Manager and FSMs</a></li><li><a href="#blocks-fetcher" class="table-of-contents__link">Blocks Fetcher</a></li><li><a href="#backtracking-procedure" class="table-of-contents__link">Backtracking procedure</a></li><li><a href="#handling-skipped-blocks" class="table-of-contents__link">Handling skipped blocks</a></li><li><a href="#utilizing-peer-scorer" class="table-of-contents__link">Utilizing peer scorer</a></li></ul></li><li><a href="#testing" class="table-of-contents__link">Testing</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_MyFc" href="/docs/getting-started"><img src="/img/Agora-cl.svg" alt="Agora-cl Docs" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/Agora-cl.svg" alt="Agora-cl Docs" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright ¬© 2022 Bosagora, Validator Deposit Contract 0xXXX</div></div></div></footer></div>
<script src="/assets/js/runtime~main.bf2263fc.js"></script>
<script src="/assets/js/main.a87cd8b8.js"></script>
</body>
</html>